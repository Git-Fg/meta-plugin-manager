{
  "type": "diff",
  "patch": [
    {
      "file": "src/auth/login.ts",
      "additions": 45,
      "deletions": 12,
      "changes": [
        {
          "line": 1,
          "content": "+import jwt from 'jsonwebtoken';",
          "type": "add"
        },
        {
          "line": 2,
          "content": "+import bcrypt from 'bcrypt';",
          "type": "add"
        },
        {
          "line": 15,
          "content": "-    if (password === storedPassword) {",
          "type": "remove"
        },
        {
          "line": 16,
          "content": "+    const isValid = await bcrypt.compare(password, storedPassword);",
          "type": "remove"
        },
        {
          "line": 17,
          "content": "+    if (!isValid) return { error: 'Invalid credentials' };",
          "type": "add"
        },
        {
          "line": 25,
          "content": "+    const token = jwt.sign({ userId: user.id, email: user.email }, process.env.JWT_SECRET);",
          "type": "add"
        },
        {
          "line": 30,
          "content": "+    return { token, user: { id: user.id, email: user.email } };",
          "type": "remove"
        }
      ]
    },
    {
      "file": "src/auth/middleware.ts",
      "additions": 32,
      "deletions": 8,
      "changes": [
        {
          "line": 1,
          "content": "+import jwt from 'jsonwebtoken';",
          "type": "add"
        },
        {
          "line": 10,
          "content": "+export const authenticateToken = (req, res, next) => {",
          "type": "add"
        },
        {
          "line": 11,
          "content": "+  const authHeader = req.headers['authorization'];",
          "type": "add"
        },
        {
          "line": 12,
          "content": "+  const token = authHeader?.split(' ')[1];",
          "type": "add"
        },
        {
          "line": 13,
          "content": "+  if (!token) return res.status(401).json({ error: 'Access token required' });",
          "type": "add"
        },
        {
          "line": 14,
          "content": "+  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {",
          "type": "add"
        },
        {
          "line": 15,
          "content": "+    if (err) return res.status(403).json({ error: 'Invalid token' });",
          "type": "add"
        },
        {
          "line": 20,
          "content": "+  });",
          "type": "add"
        },
        {
          "line": 25,
          "content": "+export default authenticateToken;",
          "type": "add"
        }
      ]
    },
    {
      "file": "tests/auth/login.test.ts",
      "additions": 28,
      "deletions": 5,
      "changes": [
        {
          "line": 1,
          "content": "+import request from 'supertest';",
          "type": "add"
        },
        {
          "line": 5,
          "content": "+describe('POST /api/auth/login', () => {",
          "type": "add"
        },
        {
          "line": 6,
          "content": "+  it('should return token on valid credentials', async () => {",
          "type": "add"
        },
        {
          "line": 7,
          "content": "+    const response = await request(app)",
          "type": "add"
        },
        {
          "line": 8,
          "content": "+      .post('/api/auth/login')",
          "type": "add"
        },
        {
          "line": 9,
          "content": "+      .send({ email: 'test@example.com', password: 'password123' });",
          "type": "add"
        },
        {
          "line": 10,
          "content": "+    expect(response.status).toBe(200);",
          "type": "add"
        },
        {
          "line": 11,
          "content": "+    expect(response.body.token).toBeDefined();",
          "type": "add"
        },
        {
          "line": 15,
          "content": "+  it('should return error on invalid credentials', async () => {",
          "type": "add"
        }
      ]
    }
  ]
}
